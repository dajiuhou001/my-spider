name: Auto Spider Bot
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_spider:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install
        run: npm install axios cheerio

      - name: Create Script
        run: |
          cat << 'EOF' > spider_script.js
          if (typeof File === 'undefined') {
            const { Blob } = require('buffer');
            global.File = class extends Blob {
              constructor(parts, filename, options = {}) {
                super(parts, options);
                this.name = filename;
                this.lastModified = options.lastModified || Date.now();
              }
            };
          }
          const axios = require('axios');
          const cheerio = require('cheerio');
          async function run() {
            try {
              const res = await axios.post('https://s.url99.me/7cnr519a', 'password=160301', {
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
              });
              const $ = cheerio.load(res.data);
              const list = [];
              $('tr.el-table__row').each((i, el) => {
                const num = $(el).find('.el-table_1_column_1 .cell').text().trim();
                const sts = $(el).find('.el-table_1_column_3 .cell span').text().trim();
                if (sts.includes('在线') && num) list.push({ number: num, status: '在线' });
              });
              if (list.length > 0) {
                await axios.post('http://204.141.218.119:4000/api/update', { data: list });
                console.log('Success sync ' + list.length);
              }
            } catch (e) { console.error(e.message); process.exit(1); }
          }
          run();
          EOF

      - name: Run
        run: node spider_script.js
