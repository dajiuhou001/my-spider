name: Auto Spider Bot

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_spider:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Libs
        run: npm install playwright cheerio

      - name: Install Browser
        run: npx playwright install chromium --with-deps

      - name: Create Script
        run: |
          cat << 'EOF' > spider_script.js
          const { chromium } = require('playwright');
          const cheerio = require('cheerio');
          const http = require('http');

          function pushData(data) {
            return new Promise((resolve) => {
              const postData = JSON.stringify({ data });
              const options = {
                hostname: '204.141.218.119',
                port: 4000,
                path: '/api/update',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(postData)
                }
              };
              const req = http.request(options, (res) => resolve(res.statusCode));
              req.on('error', () => resolve('Error'));
              req.write(postData);
              req.end();
            });
          }

          async function run() {
            console.log('--- 启动虚拟列表深度滑动采集 ---');
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36 Edg/143.0.0.0'
            });

            await context.addCookies([{
              name: 'cf_clearance',
              value: 'hGqOKGlLUQOdBIMiOFvKOcW3kPBkvDPr5XgRTJMCQ_U-1767995732-1.2.1.1-zMyCvc_wL_LFCvoBTlaImCPAkZMwlUBilOFVRBjpccUJliQBGGriP9Ma6y_iqalTDGI4A8Q31RYfIWvaSplc4qIoKTmE._DLgYqMmbJccjcrm_TDsoCAr2oIOnzgh2cRmvo0xzROXn40cD.OyhtOvWYXDK49gq2GfliqGO8t85HGDhdeDd7vybMQV3SLWSYG6mhoR6KHPs9SgUkrk4aZEr9vaNrMyYYUFMIBNqpGHOo',
              domain: 's.url99.me',
              path: '/'
            }]);

            const page = await context.newPage();
            try {
              console.log('1. 进入系统...');
              await page.goto('https://s.url99.me/7cnr519a', { waitUntil: 'networkidle', timeout: 60000 });
              
              // 等待表格渲染
              await page.waitForSelector('.el-table__body-wrapper', { timeout: 20000 });

              const onlineNumbers = new Set();
              console.log('2. 开始模拟滑动采集...');

              // 在浏览器环境中执行滑动逻辑
              for (let i = 0; i < 10; i++) { // 假设滑动10次能覆盖全表
                // 获取当前页面的在线号码
                const currentData = await page.evaluate(() => {
                  const results = [];
                  document.querySelectorAll('tr.el-table__row').forEach(row => {
                    if (row.innerText.includes('在线')) {
                      const cells = row.querySelectorAll('td .cell');
                      if (cells.length > 0) {
                        results.push(cells[0].innerText.trim());
                      }
                    }
                  });
                  return results;
                });

                // 加入去重集合
                currentData.forEach(num => onlineNumbers.add(num));

                // 执行滑动：寻找 ElementUI 的滚动容器并向下滚动 400 像素
                await page.evaluate(() => {
                  const scrollBox = document.querySelector('.el-table__body-wrapper');
                  if (scrollBox) {
                    scrollBox.scrollTop += 400;
                  } else {
                    window.scrollBy(0, 400); // 备用方案
                  }
                });

                await page.waitForTimeout(1500); // 等待异步加载渲染
              }

              const finalData = Array.from(onlineNumbers).map(num => ({ number: num, status: '在线' }));
              console.log(`3. 深度采集完成！共抓取到 ${finalData.length} 个不重复的在线号码`);
              console.log('具体号码:', Array.from(onlineNumbers).join(', '));

              if (finalData.length > 0) {
                const status = await pushData(finalData);
                console.log('4. 推送状态:', status);
              }

            } catch (e) {
              console.error('❌ 执行失败:', e.message);
            } finally {
              await browser.close();
            }
          }
          run();
          EOF

      - name: Run
        run: node spider_script.js
