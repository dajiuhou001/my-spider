name: Dynamic Spider Bot

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_spider:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Libs
        run: npm install playwright axios

      - name: Install Browser
        run: npx playwright install chromium --with-deps

      - name: Run Dynamic Spider
        run: |
          cat << 'EOF' > spider_script.js
          const { chromium } = require('playwright');
          const axios = require('axios');

          // 修改为你的服务器 IP
          const SERVER_IP = '204.141.218.119'; 

          async function run() {
            try {
              console.log('1. 从宝塔下载动态配置...');
              const configRes = await axios.get(`http://${SERVER_IP}:4000/config.json`);
              const { url, password } = configRes.data;
              
              if (!url || !password) throw new Error('配置无效');
              console.log(`执行目标: ${url}`);

              const browser = await chromium.launch({ headless: true });
              const context = await browser.newContext({
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
              });

              // 注入之前成功的 Cookie
              await context.addCookies([{
                name: 'cf_clearance',
                value: 'hGqOKGlLUQOdBIMiOFvKOcW3kPBkvDPr5XgRTJMCQ_U-1767995732-1.2.1.1-zMyCvc_wL_LFCvoBTlaImCPAkZMwlUBilOFVRBjpccUJliQBGGriP9Ma6y_iqalTDGI4A8Q31RYfIWvaSplc4qIoKTmE._DLgYqMmbJccjcrm_TDsoCAr2oIOnzgh2cRmvo0xzROXn40cD.OyhtOvWYXDK49gq2GfliqGO8t85HGDhdeDd7vybMQV3SLWSYG6mhoR6KHPs9SgUkrk4aZEr9vaNrMyYYUFMIBNqpGHOo',
                domain: 's.url99.me', path: '/'
              }]);

              const page = await context.newPage();
              await page.goto(url, { waitUntil: 'networkidle', timeout: 60000 });

              // 自动解锁
              console.log('2. 正在解锁工单...');
              const inputSelector = 'input[type="password"], .el-input__inner';
              await page.waitForSelector(inputSelector, { timeout: 15000 });
              await page.fill(inputSelector, password);
              await page.keyboard.press('Enter');
              await page.waitForTimeout(10000);

              // 采集
              console.log('3. 扫描在线号码...');
              const results = await page.evaluate(() => {
                const list = [];
                const now = new Date().toLocaleString();
                document.querySelectorAll('tr').forEach(row => {
                  if (row.innerText.includes('在线')) {
                    const num = row.cells[0]?.innerText.trim();
                    if (num && /\d/.test(num)) list.push({ number: num, time: now });
                  }
                });
                return list;
              });

              console.log(`4. 采集完成，发现 ${results.length} 条数据`);
              
              // 回传到宝塔
              await axios.post(`http://${SERVER_IP}:4000/api/update`, { data: results });
              console.log('5. 数据已回传至服务器');

              await browser.close();
            } catch (e) {
              console.error('❌ 执行失败:', e.message);
            }
          }
          run();
          EOF
          node spider_script.js
