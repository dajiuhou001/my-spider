- name: Create Script File
        run: |
          cat << 'EOF' > spider_script.js
          // --- 1. 环境补丁：解决 Node 18 的 ReferenceError: File is not defined ---
          if (typeof File === 'undefined') {
              const { Blob } = require('buffer');
              global.File = class extends Blob {
                  constructor(parts, filename, options = {}) {
                      super(parts, options);
                      this.name = filename;
                      this.lastModified = options.lastModified || Date.now();
                  }
              };
          }

          const axios = require('axios');
          const cheerio = require('cheerio');

          async function run() {
            console.log('--- 启动爬虫任务 ---');
            try {
              // 2. 抓取目标网站
              console.log('正在抓取数据...');
              const res = await axios.post('https://s.url99.me/7cnr519a', 'password=160301', {
                headers: { 
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                }
              });

              const $ = cheerio.load(res.data);
              const list = [];
              
              $('tr.el-table__row').each((i, el) => {
                const number = $(el).find('.el-table_1_column_1 .cell').text().trim();
                const status = $(el).find('.el-table_1_column_3 .cell span').text().trim();
                if (status.includes('在线') && number) {
                  list.push({ number, status: '在线' });
                }
              });

              console.log('抓取成功，在线号码数量:', list.length);

              // 3. 推送到宝塔服务器
              if (list.length > 0) {
                  console.log('正在同步到服务器...');
                  await axios.post('http://204.141.218.119:4000/api/update', { data: list }, { timeout: 10000 });
                  console.log('数据已同步成功！');
              } else {
                  console.log('本次未发现在线号码，跳过同步。');
              }

            } catch (e) {
              console.error('❌ 任务失败:', e.message);
              // 如果是推送失败，打印详细信息
              if (e.config && e.config.url.includes('api/update')) {
                  console.error('请检查宝塔服务器 4000 端口是否放行，且项目正在运行');
              }
              process.exit(1);
            }
          }
          run();
          EOF
