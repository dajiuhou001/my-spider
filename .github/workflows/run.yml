name: Auto Spider Bot
on:
  schedule:
    - cron: '*/15 * * * *' # 每15分钟自动跑一次
  workflow_dispatch:      # 允许你手动点按钮运行

jobs:
  run_spider:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install axios cheerio

      - name: Run Scraping Script
        run: |
          node -e "
          const axios = require('axios');
          const cheerio = require('cheerio');
          async function run() {
            try {
              // 1. 抓取目标网站
              const res = await axios.post('https://s.url99.me/7cnr519a', 'password=160301', {
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
              });
              const $ = cheerio.load(res.data);
              const list = [];
              $('tr.el-table__row').each((i, el) => {
                const number = \$(el).find('.el-table_1_column_1 .cell').text().trim();
                const status = \$(el).find('.el-table_1_column_3 .cell span').text().trim();
                if (status === '在线' && number) {
                  list.push({ number, status });
                }
              });
              console.log('抓取到在线号码数量:', list.length);
              
              // 2. 推送给你宝塔上的接收接口 (请确保你宝塔上的代码已更新为我上次给你的接收版)
              await axios.post('http://http://204.141.218.119/:4000/api/update', { data: list });
              console.log('已成功推送到服务器');
            } catch (e) {
              console.error('任务失败:', e.message);
            }
          }
          run();
          "
