name: Auto Spider Bot

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_spider:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Libs
        run: npm install playwright cheerio

      - name: Install Browser
        run: npx playwright install chromium --with-deps

      - name: Create Script
        run: |
          cat << 'EOF' > spider_script.js
          const { chromium } = require('playwright');
          const http = require('http');

          // 配置信息
          const QUERY_PASSWORD = '160301'; 
          const TARGET_URL = 'https://s.url99.me/7cnr519a';
          const PUSH_URL = '204.141.218.119';

          function pushData(data) {
            return new Promise((resolve) => {
              const postData = JSON.stringify({ data });
              const options = {
                hostname: PUSH_URL, port: 4000, path: '/api/update', method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Content-Length': Buffer.byteLength(postData) }
              };
              const req = http.request(options, (res) => resolve(res.statusCode));
              req.on('error', () => resolve('Error'));
              req.write(postData);
              req.end();
            });
          }

          async function run() {
            console.log('--- 启动自动解锁爬取模式 ---');
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              viewport: { width: 1920, height: 1080 }
            });

            await context.addCookies([{
              name: 'cf_clearance',
              value: 'hGqOKGlLUQOdBIMiOFvKOcW3kPBkvDPr5XgRTJMCQ_U-1767995732-1.2.1.1-zMyCvc_wL_LFCvoBTlaImCPAkZMwlUBilOFVRBjpccUJliQBGGriP9Ma6y_iqalTDGI4A8Q31RYfIWvaSplc4qIoKTmE._DLgYqMmbJccjcrm_TDsoCAr2oIOnzgh2cRmvo0xzROXn40cD.OyhtOvWYXDK49gq2GfliqGO8t85HGDhdeDd7vybMQV3SLWSYG6mhoR6KHPs9SgUkrk4aZEr9vaNrMyYYUFMIBNqpGHOo',
              domain: 's.url99.me', path: '/'
            }]);

            const page = await context.newPage();
            try {
              console.log('1. 进入页面...');
              await page.goto(TARGET_URL, { waitUntil: 'networkidle', timeout: 60000 });

              // 2. 处理密码弹窗
              console.log('2. 检测到弹窗，正在输入密码...');
              // 寻找输入框（适配 el-input）
              const inputSelector = 'input[type="password"], .el-input__inner';
              await page.waitForSelector(inputSelector, { timeout: 15000 });
              await page.fill(inputSelector, QUERY_PASSWORD);
              
              console.log('3. 点击确定并等待渲染...');
              // 寻找包含“确定”字样的按钮
              const btnSelector = 'button:has-text("确定"), .el-button--primary';
              await page.click(btnSelector);
              
              // 提交密码后强制等待，确保表格从“暂无数据”变为真实数据
              await page.waitForTimeout(12000);

              // 3. 虚拟列表滑动解析
              console.log('4. 开始深度扫描数据...');
              const onlineNumbers = new Set();
              
              // 模拟滚动 5 次以覆盖虚拟列表
              for (let s = 0; s < 5; s++) {
                const content = await page.content();
                const $ = require('cheerio').load(content);
                
                $('tr').each((i, el) => {
                  const rowText = $(el).text();
                  if (rowText.includes('在线')) {
                    const num = $(el).find('td').eq(0).text().trim();
                    if (num && /\d/.test(num)) {
                      onlineNumbers.add(num);
                    }
                  }
                });
                
                // 向下滚动表格
                await page.evaluate(() => {
                  const box = document.querySelector('.el-table__body-wrapper');
                  if (box) box.scrollTop += 500;
                  else window.scrollBy(0, 500);
                });
                await page.waitForTimeout(1500);
              }

              const finalData = Array.from(onlineNumbers).map(n => ({number: n, status: '在线'}));
              console.log(`5. 抓取总结: 共发现 ${finalData.length} 个在线号码`);

              if (finalData.length > 0) {
                  console.log('在线列表:', Array.from(onlineNumbers).join(', '));
                  const status = await pushData(finalData);
                  console.log('6. 推送至宝塔状态:', status);
              } else {
                  console.log('警告：输入密码后仍未发现“在线”数据，请检查密码或Cookie时效');
              }

            } catch (e) {
              console.error('❌ 执行失败:', e.message);
              // 失败时再次截图，方便你排查
              await page.screenshot({ path: 'final_error.png' });
            } finally {
              await browser.close();
              console.log('--- 任务结束 ---');
            }
          }
          run();
          EOF

      - name: Run
        run: node spider_script.js
